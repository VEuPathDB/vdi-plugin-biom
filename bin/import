#!/usr/bin/bash

set -e

INPUT_DIR=$1
RESULTS_DIR=$2

WORKING_DIR=$PWD

cp $INPUT_DIR/* $WORKING_DIR/

function confReplace() {
  sed -i "s#$1.*#$2#" $GUS_CONFIG
}

DB_NAME=`date +%Y%M%d%H%m%S`
GUS_CONFIG=$WORKING_DIR/gus.config
GEO_MAPPINGS=/usr/local/lib/xml/geoMappings.xml

echo "WORKING Directory = ${WORKING_DIR}"

echo "validate biom file and make metadata.json and data.tsv files"
validateAndPreprocess $INPUT_DIR $WORKING_DIR

cp $GUS_HOME/config/gus.config $GUS_CONFIG
confReplace "${TEMPLATE_DB_NAME}" "$DB_NAME"

echo "MAKING database ${DB_NAME}"
createdb -T $TEMPLATE_DB_NAME -U postgres $DB_NAME

echo "Write Config ..."
writeNextflowConfig --workdir ${WORKING_DIR} \
  --gusConfigFile $GUS_CONFIG \
  --name $DB_NAME \
  --geoMappings $GEO_MAPPINGS \
  --resultsDir ${RESULTS_DIR} \
  >${WORKING_DIR}/nextflow.config

echo "Begin Loading ..."
nextflow -C ${WORKING_DIR}/nextflow.config \
  run $PROJECT_HOME/eda-nextflow/main.nf \
  -ansi-log false \
  -entry loadBiomUserDataset

echo "Dropping Database ${DB_NAME}"
dropdb -f -U postgres ${DB_NAME}
